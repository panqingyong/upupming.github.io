<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="小程序开发经验总结"><meta name="keywords" content="HITMers"><meta name="author" content="upupming"><meta name="copyright" content="upupming"><title>小程序开发经验总结 | upupming 的博客</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="manifest" href="/manifest.json"><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#1B9EF3"><meta name="msapplication-TileColor" content="#1B9EF3"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#1B9EF3"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-2188191456032650',
  enable_page_level_ads: 'true'
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?295ad5c5a196e4964e20f74260711177";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-114899088-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"5WEDOKLFCL","apiKey":"26a57bfa5275b7c98a3b3ab7dae61915","indexName":"upupming-blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#客户端-hitmers"><span class="toc-number">1.</span> <span class="toc-text"> 客户端: HITmers</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-ui-库"><span class="toc-number">1.1.</span> <span class="toc-text"> 使用 UI 库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#封装-toast-notify"><span class="toc-number">1.2.</span> <span class="toc-text"> 封装 Toast、Notify</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#promise-异步请求-请求错误处理"><span class="toc-number">1.3.</span> <span class="toc-text"> Promise 异步请求 &amp; 请求错误处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#国际化"><span class="toc-number">1.4.</span> <span class="toc-text"> 国际化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#请求域名设置"><span class="toc-number">1.5.</span> <span class="toc-text"> 请求域名设置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#服务端hitmers-node-js-server"><span class="toc-number">2.</span> <span class="toc-text"> 服务端：HITMers-node-js-server</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#koa-knex"><span class="toc-number">2.1.</span> <span class="toc-text"> Koa + Knex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试优先"><span class="toc-number">2.2.</span> <span class="toc-text"> 测试优先</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开发环境-生产环境"><span class="toc-number">2.3.</span> <span class="toc-text"> 开发环境 &amp; 生产环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#授权机制"><span class="toc-number">2.4.</span> <span class="toc-text"> 授权机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#travis-ci-coveralls"><span class="toc-number">2.5.</span> <span class="toc-text"> Travis-CI &amp; Coveralls</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">3.</span> <span class="toc-text"> 总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#外部链接"><span class="toc-number">4.</span> <span class="toc-text"> 外部链接</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/doraemon.jpeg"></div><div class="author-info__name text-center">upupming</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">41</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">49</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">26</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友情链接</div><a class="author-info-links__name text-center" href="https://molunerfinn.com/">MARKSZのBlog</a><a class="author-info-links__name text-center" href="https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/master/README-zh_CN.md">提问的智慧</a><a class="author-info-links__name text-center" href="https://zh.wikipedia.org/">中文维基百科</a><a class="author-info-links__name text-center" href="https://zbqtesla.github.io">ZBQTesla的博客</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/background.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">upupming 的博客</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a><a class="site-page" href="https://mirror.upupming.site">Mirror</a><a class="site-page" href="https://music.wxhbts.com">音乐</a><a class="site-page" href="https://writing.upupming.site">Writing</a><a class="site-page" href="/about">关于</a><a class="site-page" href="/rss">RSS</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">小程序开发经验总结</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-09-12</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/项目/">项目</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/项目/微信小程序/">微信小程序</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">3.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 12 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>本文主要介绍了小程序客户端、服务器端开发（RESTful API）的相关经验。</p>
<a id="more"></a>
<figure class="not-code">
<img src="first-commit.png">
<caption>HITMers 第一个 commit</caption>
</figure>
<p>经过近两个月的学习和开发，目前为哈工大博物馆开发的小程序 HITMers 已经进入测试阶段，马上就要发布正式版啦！在此特意总结一下相关的经验，也希望可以帮助到更多的人！</p>
<h1 id="客户端-hitmers"><a class="markdownIt-Anchor" href="#客户端-hitmers"></a> 客户端: <a href="https://github.com/upupming/HITMers" target="_blank" rel="noopener">HITmers</a></h1>
<p>客户端算是比较简单的一部分，主要就是 UI 设计和逻辑交互两大块。</p>
<h2 id="使用-ui-库"><a class="markdownIt-Anchor" href="#使用-ui-库"></a> 使用 UI 库</h2>
<p>在 UI 这块刚开始只是使用官方的一些组件，但后来发现大部分组件使用起来需要设置比较多的 CSS 属性，支持的操作也比较少。后来了解到了一些使用<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/" target="_blank" rel="noopener">自定义组件</a>功能开发出的 UI 库：</p>
<ol>
<li><a href="https://github.com/Tencent/weui-wxss" target="_blank" rel="noopener">WeUI</a></li>
</ol>
<p>由微信官方设计团队开发，缺点是很久没有更新，到现在为止的重要 commit 停留在 2017 年 6 月前后，所以不打算使用。</p>
<ol start="2">
<li><a href="https://github.com/youzan/zanui-weapp" target="_blank" rel="noopener">赞 UI</a></li>
</ol>
<p>由有赞维护，非常活跃，不断在增加新的组件。因此我考虑选用赞 UI 的这些组件为基础进行开发。</p>
<ol start="3">
<li><a href="https://github.com/youzan/vant-weapp" target="_blank" rel="noopener">Vant UI</a></li>
</ol>
<p>在我开发到一半的时候，有赞将赞 UI 改名 Vant UI，新的 Vant UI 看起来比原来的赞 UI 确实要好许多，不过目前有一些组件还没有，比如 <code>dot</code> 类型的 loading 组件、dialog 组件等。</p>
<p>组件的使用非常简单，建议直接将 Vant UI 的源代码克隆到本地，然后在开发者工具里面运行起来或者直接用手机微信搜索『Vant 组件库演示』运行，看到合适的组件就可以在 <code>example/pages</code> 文件夹下对应组件的目录里面看一下使用方法。</p>
<p>比如经常用到的 <code>cell</code> 组件，展示箭头的示例代码如下（使用时一定不要忘了在 <code>json</code> 文件中引入相应组件）：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">demo-block</span> <span class="attr">title</span>=<span class="string">"展示箭头"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">"单元格"</span> <span class="attr">is-link</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-cell</span> <span class="attr">title</span>=<span class="string">"单元格"</span> <span class="attr">is-link</span> <span class="attr">value</span>=<span class="string">"内容"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">van-cell</span></span></span><br><span class="line"><span class="tag">      <span class="attr">title</span>=<span class="string">"单元格"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">is-link</span></span></span><br><span class="line"><span class="tag">      <span class="attr">arrow-direction</span>=<span class="string">"down"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">value</span>=<span class="string">"内容"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">border</span>=<span class="string">"&#123;&#123; false &#125;&#125;"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">url</span>=<span class="string">"/pages/dashboard/index"</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">van-cell-group</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">demo-block</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看到，只需要简单的设置一个 <code>is-link</code> 属性就能展示箭头，这非常简洁。如果需要了解全部属性的话，可以查阅<a href="https://youzan.github.io/vant-weapp" target="_blank" rel="noopener">官方文档</a>。</p>
<p>后续如不作说明均使用 <code>zan-ui</code> 和 <code>van-ui</code> 代表着两个组件库。</p>
<h2 id="封装-toast-notify"><a class="markdownIt-Anchor" href="#封装-toast-notify"></a> 封装 Toast、Notify</h2>
<p>使用 van-ui 的 Toast 和 Notify 都比较简单，首先需要在 <code>json</code> 中引入组件，然后在 <code>wxml</code> 中添加一个 <code>&lt;van-toast id=&quot;van-toast&quot;&gt;&lt;/van-toast&gt;</code> 或 <code>&lt;van-notify id=&quot;van-notify&quot;&gt;&lt;/van-notify&gt;</code> 元素，后续在 <code>js</code> 中展示 Toast 或 Notify：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Toast <span class="keyword">from</span> <span class="string">'../van-ui/toast/index'</span>;</span><br><span class="line">Toast(<span class="string">'toast message'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Notify <span class="keyword">from</span> <span class="string">'../van-ui/notify/index'</span>;</span><br><span class="line">Notify(<span class="string">'notify message);</span></span><br></pre></td></tr></table></figure>
<p>为了更高效地展示 Toast 和 Notify，封装一个 <code>util.js</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Toast <span class="keyword">from</span> <span class="string">'../van-ui/toast/index'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params">message, type</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(type) &#123;</span><br><span class="line">    Toast[type](message);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Toast(message);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123; </span><br><span class="line">  show</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以在页面 <code>js</code> 里面调用封装好的辅助函数：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">'../../utils/util'</span>);</span><br><span class="line">util.show(<span class="string">'Failed: ...'</span>, <span class="string">'fail'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="promise-异步请求-请求错误处理"><a class="markdownIt-Anchor" href="#promise-异步请求-请求错误处理"></a> Promise 异步请求 &amp; 请求错误处理</h2>
<p>小程序提供的异步 API 都是采用回调的形式处理结果的，这有一个很大的缺点就是代码不够整洁，层层嵌套的代码将变得非常糟糕，感兴趣的同学可以看一下 <a href="https://javascript.info/callbacks#pyramid-of-doom" target="_blank" rel="noopener">Pyramid of doom</a>。</p>
<p><a href="https://github.com/youngjuning/wxPromise" target="_blank" rel="noopener">wxPromise</a> 实现了所有回调转换为 <a href="https://javascript.info/promise-basics" target="_blank" rel="noopener">Promise</a>。其核心思想非常简单：返回一个新的 Promise，在回调 success 时 resolve，fail 时 reject：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 把普通函数变成promise函数</span></span><br><span class="line"><span class="keyword">const</span> promisify = <span class="function">(<span class="params">api</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">options, ...params</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      api(<span class="built_in">Object</span>.assign(&#123;&#125;, options, &#123;</span><br><span class="line">        success: resolve,</span><br><span class="line">        fail: reject</span><br><span class="line">      &#125;), ...params)</span><br><span class="line">      <span class="built_in">Promise</span>.prototype.finally = <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> P = <span class="keyword">this</span>.constructor</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.then(</span><br><span class="line">          value  =&gt; P.resolve(callback()).then(<span class="function"><span class="params">()</span> =&gt;</span> value),</span><br><span class="line">          reason =&gt; P.resolve(callback()).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123; <span class="keyword">throw</span> reason &#125;)</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> wxPromise = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> wx) &#123;</span><br><span class="line">    <span class="keyword">if</span> (wx.hasOwnProperty(key)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="regexp">/^on|^create|Sync$|Manager$|^pause/</span>.test(key) &amp;&amp; key !== <span class="string">'createBLEConnection'</span> || key === <span class="string">'stopRecord'</span> || key === <span class="string">'stopVoice'</span> || key === <span class="string">'stopBackgroundAudio'</span> || key === <span class="string">'stopPullDownRefresh'</span> || key === <span class="string">'hideKeyboard'</span> || key === <span class="string">'hideToast'</span> || key === <span class="string">'hideLoading'</span> || key === <span class="string">'showNavigationBarLoading'</span> || key === <span class="string">'hideNavigationBarLoading'</span> || key === <span class="string">'canIUse'</span> || key === <span class="string">'navigateBack'</span> || key === <span class="string">'closeSocket'</span> || key === <span class="string">'closeSocket'</span> || key === <span class="string">'pageScrollTo'</span> || key === <span class="string">'drawCanvas'</span>) &#123;</span><br><span class="line">        wx.pro[key] = wx[key]</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 遍历所有回调 API，将其异步化并放到 wx.pro 之下</span></span><br><span class="line">        wx.pro[key] = promisify(wx[key])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">wxPromise();</span><br></pre></td></tr></table></figure>
<p>除了使用 <code>wx.pro</code> 简化代码结构，我还发现每次 <code>wx.pro.request</code> 之后都要调用 <code>.catch</code> 来检查是否出现错误来通知用户，请求没有错误的时候也要校验是否出现错误状态码 <code>4xx</code>，重复地书写这写代码非常没有必要，因此将其封装进 <code>requests.js</code> 中：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 错误处理函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">errorHandler</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.error(err);</span><br><span class="line">  Toast.clear();</span><br><span class="line">  Notify(globalData.language.requestError + <span class="string">': '</span> + <span class="built_in">JSON</span>.stringify(err.errMsg));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 状态码校验函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">statusCodeChecker</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res);</span><br><span class="line">  Toast.clear();</span><br><span class="line">  <span class="keyword">if</span>(res.statusCode === <span class="number">200</span>) &#123;</span><br><span class="line">    <span class="comment">// Notify(&#123;</span></span><br><span class="line">    <span class="comment">//   text: globalData.language.requestSuccess,</span></span><br><span class="line">    <span class="comment">//   backgroundColor: '#38f'</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Notify(&#123;</span><br><span class="line">      text: globalData.language.requestError + <span class="string">': '</span> + res.statusCode + <span class="string">' '</span> + globalData.language[res.statusCode] + <span class="string">' '</span> + <span class="built_in">JSON</span>.stringify(res.data)</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// Throw error with message from the server</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="built_in">Error</span>(res.data);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getUserInfo(id) &#123;</span><br><span class="line">    <span class="keyword">return</span> request(&#123;</span><br><span class="line">      url: service.user + <span class="string">'/'</span> + id,</span><br><span class="line">      method: <span class="string">'GET'</span>,</span><br><span class="line">      header: &#123;</span><br><span class="line">        <span class="string">'x-access-token'</span>: globalData.token</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 在这里复用这些函数</span></span><br><span class="line">    &#125;).catch(errorHandler)</span><br><span class="line">      .then(statusCodeChecker);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="国际化"><a class="markdownIt-Anchor" href="#国际化"></a> 国际化</h2>
<p>小程序国际化已经在 <a href="../../../../2018/07/23/mini-program-i18n/">微信小程序语言切换</a> 中有过介绍了。</p>
<p>另外，相信读者在看到上一部分请求的封装时已经看到了 <code>globalData.language</code> 而不是 <code>wx.T.getLanguage()</code>，这是一种更加简洁的方式。我们在每次修改语言时都更新一下 <code>globalData.language</code>，调用 <code>requests.js</code> 时也会相应跟着改变。原来的 <code>event.on('languageChanged', this, this.setLanguage);</code> 还是需要保留的，这是为了每次修改语言时调用未 onShow 的页面的 <code>setData</code> 修改其页面数据。</p>
<p><strong>关于 <code>globalData</code>：</strong></p>
<p>小程序中的 <code>globalData</code> 在任何页面都可以修改，在其他页面访问时也会实时更新，建议将一些全局信息存到 <code>globalData</code> 中方便使用，还可以将 <code>globalData</code> 存储到用户缓存，下次加载时恢复。</p>
<p><code>globalData</code> 时常更新，如果要使用 <code>globalData</code> 中的值进行数据绑定，最好在页面 onLoad 或 onShow 时 <code>setData</code> 而不是单纯地将 <code>data</code> 里的数据委托到 <code>globalData</code> 上。</p>
<h2 id="请求域名设置"><a class="markdownIt-Anchor" href="#请求域名设置"></a> 请求域名设置</h2>
<p>在开发模式下，使用本地运行的 Node.js 监听地址作为 request 域名，在生产模式则使用真实的域名。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> host;</span><br><span class="line"><span class="keyword">let</span> env = <span class="string">'dev'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(env === <span class="string">'production'</span>) &#123;</span><br><span class="line">  host = <span class="string">'https://hitmers-api.solotime.xyz'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// dev 环境下在电脑上使用 iphone 5；手机端则是安卓，只能使用真实域名</span></span><br><span class="line">  host = wx.getSystemInfoSync().model === <span class="string">'iPhone 5'</span> ? <span class="string">'http://localhost:5757'</span>: <span class="string">'https://hitmers-api.solotime.xyz'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="服务端hitmers-node-js-server"><a class="markdownIt-Anchor" href="#服务端hitmers-node-js-server"></a> 服务端：<a href="https://github.com/upupming/HITMers-node-js-server" target="_blank" rel="noopener">HITMers-node-js-server</a></h1>
<p>刚开始入门的时候一直在使用<a href="https://github.com/tencentyun/wafer2-quickstart-nodejs" target="_blank" rel="noopener">腾讯云 wafer 解决方案</a>，随着开发的进行，发现一些问题：</p>
<ol>
<li>
<p>客户端、服务端代码在同一个项目里面，而客户端是网页 js，服务端是 Nodejs，两者有完全不同的库，比如客户端无法使用 <code>await/async</code>、<code>Buffer</code>、<code>process.env</code>、npm 安装依赖等等。</p>
</li>
<li>
<p>效率极其低下，每次写完服务端代码需要『上传 -&gt; 安装依赖 -&gt; 重启』 2 -3 分钟，遇到错误还得远程调试，连接过程更是长达 1 分钟左右。</p>
</li>
<li>
<p>只能通过 phpMyAdmin 连接数据库，knex 的 migration 功能无法实现，这意味着测试数据的添加必须直接修改服务端逻辑代码！</p>
</li>
</ol>
<p>经过长时间的开发、不断查阅资料，终于找到了一些解决办法。</p>
<h2 id="koa-knex"><a class="markdownIt-Anchor" href="#koa-knex"></a> Koa + Knex</h2>
<p>现在主要流行的服务端一般都是采用 RESTful API，最经典的就是 GitHub API v3、豆瓣 API 等等。RESTful 使用 GET、POST、DELETE、PUT 等 HTTP 动词表示进行什么操作，而请求路径一般只包含名词。强烈推荐仔细读一读 <a href="https://mherman.org/blog/building-a-restful-api-with-koa-and-postgres/" target="_blank" rel="noopener">Building a RESTful API with Koa and Postgres</a>。另外还有一套状态码的规范，这些可以随时 Google。</p>
<p>由于刚开始使用的 wafer，也就延续了 Koa 框架和 Knex query builder，主要使用了 Koa 的中间件功能添加一些路由，<code>knex</code> 则用于查询修改数据库，支持 MySQL、Postgres 各种数据库，不用了解太多 SQL 语言就能轻松上手，遇到不会的随时查阅 <a href="http://knexjs.org" target="_blank" rel="noopener">knexjs.org</a>。</p>
<p>关于 Koa 的上手推荐读一读 <a href="http://www.ruanyifeng.com/blog/2017/08/koa.html" target="_blank" rel="noopener">Koa 框架教程</a>，『中间件』是在 Koa 中用到最多的了，及其简洁。</p>
<p>在使用 Knex 的时候可能会遇到一些问题是 SQL 相关的，除了要查阅 Knex 的文档以外，可以再看看 SQL 相关的内容。比如说中文字符串需要用到 <code>.collate('utf8_unicode_ci')</code> 就需要看看 MySQL 的文档到底有哪些可用的字符集，分别表示什么含义。</p>
<h2 id="测试优先"><a class="markdownIt-Anchor" href="#测试优先"></a> 测试优先</h2>
<p>测试非常重要，我一般是一边测试一边写文档。首先写好测试文件，运行 <code>npm test</code> 不通过之后，然后再写相关的实现代码，如果遇到错误了就需要使用 Postman 这样的工具来帮助调试，顺便把测试用例加到 API 文档中。</p>
<p>测试使用的是 <code>mocha</code>、<code>chai</code>、<code>chai-http</code>。</p>
<p><code>npm test</code>:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">node ./node_modules/mocha/bin/_mocha --timeout 10000</span><br></pre></td></tr></table></figure>
<h2 id="开发环境-生产环境"><a class="markdownIt-Anchor" href="#开发环境-生产环境"></a> 开发环境 &amp; 生产环境</h2>
<p>两种环境的部署已经在 GitHub 里面的 <a href="https://github.com/upupming/HITMers-node-js-server/blob/dev/README.md" target="_blank" rel="noopener">README.md</a> 写好了，在本地部署开发环境效率会高许多。在安装 Nginx、php、MySQL 的过程中 <a href="https://www.chanhvuong.com/2809/nginx-with-php-and-mysql-on-windows-7/" target="_blank" rel="noopener">Nginx with PHP and MySQL on Windows 7</a> 的帮助很大。在 <code>package.json</code> 中定义了 <code>npm run dev</code> 的命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nodemon --inspect --config nodemon.json src/app.js</span><br></pre></td></tr></table></figure>
<p><code>--inspect</code> 参数用于在 <code>chrome://inspect</code> 中连接到 Node.js 进程进行调试。</p>
<p>由于我使用的 MySQL 版本是 8.0，在运行 Knex 的时候遇到了一个关于授权机制 <code>caching_sha2_password</code> 小问题，我在 Stackoverflow 上总结了一下<a href="https://stackoverflow.com/questions/50093144/mysql-8-0-client-does-not-support-authentication-protocol-requested-by-server/51918364#51918364" target="_blank" rel="noopener">解决方案</a>。</p>
<p>生产环境使用的是免费的 <a href="https://devcenter.heroku.com/" target="_blank" rel="noopener">Heroku</a>，它提供免费的 Postgres 数据库是唯一靠谱的数据库（其他如 MySQL 限制数据库连接数、数据库大小 5M 等等）。最棒的是 Heroku 支持自动构建，与 GitHub 仓库关联之后可以像 Travis 一样针对每个 commit 进行构建。唯一的缺点是在国内访问网速有点差。但是可以通过使用 Heroku 的自定义域名功能，并使用 <a href="https://wangzhan.360.com" target="_blank" rel="noopener">360 网站卫士</a> 给网站加一个 CNAME 记录解析到 Heroku 应用域名（例如：<a href="http://hitmers.herokuapp.com" target="_blank" rel="noopener">hitmers.herokuapp.com</a>），再上传自己申请的 SSL 证书就可以开启 https。实际测试 360 网站卫士可以很好地加速对 Heroku 的访问速度。</p>
<p>在开发过程中经常需要用到私密性的环境变量（密码等等），可以借助 <code>dotenv</code> 将这些变量存在 <code>.env</code> 文件中并让 git ignore 掉。生产环境在 Heroku 后台中添加上即可。</p>
<p>另外 Heroku 在运行 Node.js 时注意监听端口一定要使用 <code>process.env.PORT</code>，这是 Heroku 预留的环境变量，如果尝试监听在其他端口会运行出错，参见<a href="https://help.heroku.com/P1AVPANS/why-is-my-node-js-app-crashing-with-an-r10-error" target="_blank" rel="noopener">这篇帮助</a>。</p>
<h2 id="授权机制"><a class="markdownIt-Anchor" href="#授权机制"></a> 授权机制</h2>
<p>虽然说小程序发布之后是闭源的，但实际上小程序包文件 <code>wxpkg</code> 是存储在 <code>/data/data/com.tencent.mm/MicroMsg/.../appbrand/pkg/</code> 之下的（安卓机型），而且解压之后经过一些处理源代码可以得到很好的复原，GitHub 上已经有了获取任何小程序源代码的项目 <a href="https://github.com/qwerty472123/wxappUnpacker" target="_blank" rel="noopener">wxappUnpacker</a>，我经过测试发现是完全可以复原源代码的，因此将 API 域名路径保密（比如使用 <a href="http://domain.com/v1/qwedcdgrtrfdss!@#de" target="_blank" rel="noopener">domain.com/v1/qwedcdgrtrfdss!@#de</a> 作为 API 路径）防止非法数据访问的思想是不可取的。</p>
<p>为了防止数据泄露，我们需要验证用户信息。一种简单的方法是使用 token 进行验证，HITMers 借鉴了 <a href="https://medium.freecodecamp.org/securing-node-js-restful-apis-with-json-web-tokens-9f811a92bb52" target="_blank" rel="noopener">Securing Node.js RESTful APIs with JSON Web Tokens</a>，基本思想是每次登陆返回给用户一个 token，以后用户每次发送请求都需要提供这个 token，否则返回 <code>401 Unauthorized</code>，这在 Koa 中实现起来非常简单，只需在所有 API 之前都加上一个 <a href="https://github.com/upupming/HITMers-node-js-server/blob/dev/src/controllers/verify.js" target="_blank" rel="noopener"><code>verify</code> 中间件</a>。</p>
<h2 id="travis-ci-coveralls"><a class="markdownIt-Anchor" href="#travis-ci-coveralls"></a> Travis-CI &amp; Coveralls</h2>
<p>Travis 持续集成很重要，能够确保之前的功能没有被破坏，Travis 的配置主要在 MySQL 的配置上有点问题，参见 <a href="https://github.com/travis-ci/docs-travis-ci-com/issues/1605" target="_blank" rel="noopener">issue</a>。为了数据库中的 <code>date_time</code> 跟本地调试结果一样，还要设置好时区为 <code>Asian/Shanghai</code>。其中还用到了一些 Knex migrate 和 seed 的命令初始化数据库加入测试数据，参见 <a href="https://github.com/upupming/HITMers-node-js-server/blob/dev/package.json" target="_blank" rel="noopener">package.json</a> 中的 <code>knexinit</code> 命令。</p>
<p>Coveralls 用来反馈代码测试覆盖率，配置过程参考了 <a href="http://dsernst.com/2015/09/02/node-mocha-travis-istanbul-coveralls-unit-tests-coverage-for-your-open-source-project/" target="_blank" rel="noopener">Node + Mocha + Travis + Istanbul + Coveralls: Unit tests &amp; coverage for your open source project</a>。</p>
<h1 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h1>
<p>开发完整个项目，发现主要是要学习很多新的东西，我到现在还在不断学习中。刚开始真的毫无头绪，不知不觉就慢慢地缕清晰了。还是要多写代码、多看别人怎么写的、再看看别人的文章掌握以下设计思想，效率就能够提高很多。</p>
<h1 id="外部链接"><a class="markdownIt-Anchor" href="#外部链接"></a> 外部链接</h1>
<ol>
<li><a href="https://mherman.org/blog/building-a-restful-api-with-koa-and-postgres/" target="_blank" rel="noopener">https://mherman.org/blog/building-a-restful-api-with-koa-and-postgres/</a></li>
<li><a href="https://www.chanhvuong.com/2809/nginx-with-php-and-mysql-on-windows-7/" target="_blank" rel="noopener">https://www.chanhvuong.com/2809/nginx-with-php-and-mysql-on-windows-7/</a></li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">upupming</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://upupming.site/2018/09/11/mini-program-developing/">https://upupming.site/2018/09/11/mini-program-developing/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://upupming.site">upupming 的博客</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/HITMers/">HITMers</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/10/18/katex-test/"><i class="fa fa-chevron-left">  </i><span>KaTeX Test with hexo-theme-melody</span></a></div><div class="next-post pull-right"><a href="/2018/07/23/mini-program-i18n/"><span>微信小程序语言切换（国际化）</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '77bd7cc3fdbcd3e5945a',
  clientSecret: '883971da140a8232d72918030f8c1a211a5befc1',
  repo: 'upupming.github.io',
  owner: 'upupming',
  admin: 'upupming',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(/img/background.png)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2020 By upupming</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/algolia.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script src="/js/katex.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>